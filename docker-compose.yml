services:
  nanobot:
    build: .
    container_name: nanobot
    restart: unless-stopped
    # Use the restart-aware entrypoint for MCP server installation support
    entrypoint: ["/entrypoint.sh"]
    volumes:
      # Mount local config directly for easy editing
      - ~/.nanobot:/root/.nanobot
      # Persist workspace (memory, skills, TOOLS.md, etc.) - bind mount for host visibility
      - ~/.nanobot/workspace:/app/workspace
    environment:
      # Set your API keys here or in .env file
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      # GitHub token for self-evolution PR creation (gh CLI)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GH_TOKEN=${GITHUB_TOKEN:-}
      # Workspace path inside container
      - NANOBOT_WORKSPACE=/app/workspace
    ports:
      # Gateway port (optional, for HTTP API)
      - "18790:18790"
    # For WhatsApp bridge headless browser support
    # Uncomment if using WhatsApp channel
    # shm_size: '2gb'

  # Test runner: docker compose --profile test run --rm test
  test:
    build: .
    profiles: ["test"]
    entrypoint: ["sh", "-c"]
    command:
      - |
        uv pip install --system pytest pytest-asyncio ruff &&
        echo "=== Running tests ===" &&
        pytest tests/ -v --tb=short &&
        echo "=== Linting ===" &&
        ruff check nanobot/ &&
        echo "=== Format check ===" &&
        ruff format --check nanobot/
    volumes:
      - ./tests:/app/tests:ro
    environment:
      - NANOBOT_WORKSPACE=/tmp/test-workspace
    tmpfs:
      - /tmp/test-workspace
